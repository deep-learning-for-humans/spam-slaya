version: '3.3'

services:
  flask:
    image: python:3.12-alpine
    container_name: flask
    volumes:
      - ./:/flask-app  # Mount your FastAPI app directory
    working_dir: /flask-app
    environment:
      DATABASE_URL: "sqlite:////flask-app/app.db"
    command: >
      sh -c "touch /flask-app/app.db"
    command: >
      sh -c "pip install -r requirements.txt && python run.py"
    ports:
      - "8080:8080"

  worker:
    image: python:3.12-alpine
    container_name: worker
    volumes:
      - ./:/flask-app  # Mount your FastAPI app directory
    working_dir: /flask-app
    environment:
      DATABASE_URL: "sqlite:////flask-app/app.db"
      OLLAMA_MODEL_NAME: "qwen2.5:3b-instruct-q4_0"
    command: sh -c "./setup-worker.sh"
    depends_on:
      - redisserver
      - ollama

  redisserver:
    image: redis:alpine
    container_name: redisserver
    ports:
      - "6379:6379"
    expose:
      - "6379"

  ollama:
    image: ollama/ollama:latest
    container_name: ollama
    ports:
      - "11434:11434"
    expose:
      - "11434"

    # Note: The environment variable above may vary depending on the Ollama setup.

